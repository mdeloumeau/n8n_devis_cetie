{
  "name": "IA devis cetie",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "output": "fields",
        "fields": [
          "body"
        ],
        "filters": {},
        "options": {
          "downloadAttachments": true
        }
      },
      "type": "n8n-nodes-base.microsoftOutlookTrigger",
      "typeVersion": 1,
      "position": [
        -1792,
        336
      ],
      "id": "55088b93-ad94-4448-ac81-2b3901bc783b",
      "name": "Microsoft Outlook Trigger"
    },
    {
      "parameters": {
        "operation": "pdf",
        "binaryPropertyName": "dataPDF",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -368,
        480
      ],
      "id": "f3e9f1cd-65bd-4e61-965b-c4404a06193c",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "\"mail_agent\""
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        784,
        496
      ],
      "id": "f5b6acc1-7564-44ca-83b1-3196b189a0e3",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "model": "codestral-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        640,
        496
      ],
      "id": "1787c3d0-1d45-4d22-957f-9b96ac613a0a",
      "name": "Mistral Cloud Chat Model"
    },
    {
      "parameters": {
        "model": "codestral-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1376,
        192
      ],
      "id": "2adb6df0-5597-42cf-b927-7ee3de0c956d",
      "name": "Mistral Cloud Chat Model1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "\"mail_agent\""
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1232,
        192
      ],
      "id": "4fc824e5-b9ab-417a-88bc-b4f3b51ff5db",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=renvoie seulement True si ce mail concerne une demande de devis pour une armoire √©l√©ctrique (ou un coffret) sinon tu renvoie seulement False\nvoici le mail : \n{{ $json.body }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1376,
        336
      ],
      "id": "64013083-e18f-41e8-90ba-d7ab8cc685e0",
      "name": "AI D√©t√©ction demande"
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "useDataOfInput": 2
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -816,
        336
      ],
      "id": "f750499a-e01c-4079-a555-cb966bea36a3",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Supprime les binaires et ne garde que le texte utile\nreturn items.map(item => ({\n  json: {\n    body: item.json.body?.content || \"\",\n  },\n}));\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        336
      ],
      "id": "3840bc38-a0de-4900-8e4b-7fd5d86cad9a",
      "name": "Code enlever PJ"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "519b7ba7-ed18-4611-a8da-4acd7c09cbb9",
              "leftValue": "={{ $json.output }}",
              "rightValue": "True",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1088,
        336
      ],
      "id": "16dac0fe-83a5-490f-9882-f0b6fe670763",
      "name": "demande de devis ?"
    },
    {
      "parameters": {
        "jsCode": "const itemsOut = [];\n\nfor (const item of items) {\n  // Boucle sur toutes les propri√©t√©s binaires\n  for (const key of Object.keys(item.binary || {})) {\n    const file = item.binary[key];\n    if (file.mimeType === 'application/pdf') {\n      itemsOut.push({\n        json: {\n          originalMailId: item.json.id,\n          fileName: file.fileName,\n        },\n        binary: {\n          dataPDF: file, // renommer pour Extract from PDF\n        },\n      });\n    }\n  }\n}\n\nreturn itemsOut;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        480
      ],
      "id": "67e6ea57-b890-45c3-944d-101d505d1142",
      "name": "Code avoir PDF"
    },
    {
      "parameters": {
        "jsCode": "const email = $input.all()[0].json.from;\nconst subject = $input.all()[0].json.subject || \"\";\nconst body = $('Nettoyage texte mail').first().json.text;\n\nconst attachments =\n  \"\\nR√©sum√© des pdfs :\" +\n  $('AI r√©sume texte').first().json.output +\n  \"\\nR√©sum√© du Excel :\" +\n  $('AI r√©sume Excel').first().json.output;\n\nconst fullText = `\nCorps du mail : ${body}\n\nPi√®ces jointes : ${attachments}\n`;\n\nreturn [\n  {\n    json: {\n      model: \"mistral-tiny\",\n      messages: [\n        {\n          role: \"user\",\n          content: `\nTu es un assistant expert en analyse de mails techniques pour des demandes de devis d‚Äôarmoires √©lectriques.  \nLis attentivement le mail et les pi√®ces jointes.  \nRenvoie **UNIQUEMENT un JSON valide**, sans texte ni explication.\n\nüéØ **Objectif :**\nExtraire les informations r√©ellement pr√©sentes et utiles au chiffrage, sans inventer ni supposer.\n\n---\n\n## üö´ R√®gles fondamentales\n\n1. ‚ùå **Ne jamais inventer d‚Äôinformations.**  \n   Si une donn√©e n‚Äôest pas clairement mentionn√©e, laisse le champ vide ou indique ‚ÄúNon pr√©cis√©‚Äù.\n\n2. ‚ö†Ô∏è **Ne pas dupliquer ou reformuler inutilement.**  \n   Utilise les termes exacts du texte lorsque possible.\n\n3. üìÜ **Ne jamais g√©n√©rer de date implicite.**  \n   Si aucune date n‚Äôappara√Æt dans le mail ou les pi√®ces jointes, ‚ÄúD√©lai demand√©‚Äù = ‚ÄúNon pr√©cis√©‚Äù.\n\n---\n\n## üß± Structure JSON attendue\n\n{\n  \"Client\": \"Nom de l‚Äôentreprise (en majuscules, d‚Äôapr√®s le domaine email ou signature)\",\n  \"Interlocuteur\": \"Nom complet de l‚Äôexp√©diteur (Pr√©nom Nom)\",\n  \"Armoires\": [\n    {\n      \"Titre\": \"Armoire [nombre de pompes] [Mono/Tri] [puissance kW] [intensit√© A] [portes] [socle si pr√©sent]\",\n      \"Options\": [\"√âl√©ments techniques significatifs uniquement\"],\n      \"R√©gulation\": [\"√âl√©ments li√©s √† la r√©gulation (piezzo, poires, pressostat, etc.)\"]\n    }\n  ],\n  \"D√©lai demand√©\": \"Date ou p√©riode clairement mentionn√©e (sinon 'Non pr√©cis√©')\",\n  \"Pi√®ces jointes\": [\"Noms des fichiers pertinents\"],\n  \"Notes\": [\"Contexte, contraintes ou informations compl√©mentaires utiles au devis\"]\n}\n\n---\n\n## ‚öôÔ∏è D√©tails d‚Äôextraction\n\n### üè¢ Client\n- Bas√© sur le domaine de l‚Äôexp√©diteur (ex: *@calpeda.fr ‚Üí CALPEDA*).\n- Sinon, utiliser le nom trouv√© dans la signature.\n\n### üë§ Interlocuteur\n- Toujours l‚Äôexp√©diteur du mail principal.  \n- Format : ‚ÄúPr√©nom Nom‚Äù.\n\n### ‚ö° Titre de l‚Äôarmoire\n- Regroupe uniquement les **caract√©ristiques physiques** :\n  - Nombre de pompes  \n  - Type (Mono/Tri)  \n  - Puissance (kW)  \n  - Intensit√© (A)  \n  - Nombre de portes  \n  - Socle pr√©sent ou non  \n- Ces informations sont tr√®s importantes, si elles sont dans le mail elles doivent obligatoirement apparaitre dans le titre\n- Si ‚Äúcoffret‚Äù est mentionn√©, consid√©rer comme petite armoire.  \n- Ne pas ajouter d‚Äôoptions ou de r√©gulation dans ce champ.\n\n### üîå Options\nInclure **tous les √©quipements, dispositifs et fonctionnalit√©s mentionn√©s ou sugg√©r√©s** dans le mail ou les pi√®ces jointes.  \n- Ne rien omettre si le texte indique un √©l√©ment, m√™me secondaire.  \n- Tu peux **regrouper ou reformuler l√©g√®rement** pour plus de clart√©.  \n- Inclure tout ce qui peut influencer le chiffrage ou la configuration : Sofrel, Magelis, Parafoudre, variateur de fr√©quence, relais, automates, transformateurs, r√©sistances, disjoncteurs sp√©ciaux, t√©l√©surveillance, d√©bitm√®tres, batteries, protections sp√©cifiques, alarmes, etc.  \n- Inclure √©galement tout ce qui apporte confort, s√©curit√©, surveillance ou suivi op√©rationnel.  \n\nüî¥ **√Ä exclure uniquement** :  \n- Voyants standards (sous tension, marche, d√©faut)  \n- Commutateurs Auto/Arr√™t/Manuel  \n- Compteurs horaires  \n- Voltm√®tres / amp√®rem√®tres \n- le nombre de pompes et la puissance (√† int√©grer dans le titre donc pas dans les options)\n\n### üîÑ R√©gulation\nInclure **tous les √©l√©ments de mesure, contr√¥le ou commande mentionn√©s**, m√™me s‚Äôils semblent secondaires :  \n- Sonde pi√©zo, pressostat, flotteurs, poires, d√©tecteurs de surverse, d√©tecteurs de fuite, sondes de niveau, relais de contr√¥le, automates de r√©gulation, etc.  \n- Tu peux **regrouper les √©l√©ments apparent√©s** pour plus de lisibilit√©, mais ne jamais inventer.  \n- Tout ce qui participe √† la s√©curit√©, √† la r√©gulation pr√©cise ou au fonctionnement automatis√© doit √™tre list√©.\n### ‚è±Ô∏è D√©lai demand√©\n- Utiliser la **date exacte mentionn√©e** (ex: ‚Äúmercredi 19/02/2025‚Äù).  \n- Si aucune date ou p√©riode : \"Non pr√©cis√©\".\n\n### üßæ Notes\nAjouter toute information utile au chiffrage :\n- Zone ATEX, local exigu, remplacement existant, t√©l√©surveillance, c√¢blage, contraintes √©lectriques, urgence, etc.\n\n---\n\n## üß† Exemple clair\n\n**Entr√©e :**  \n> Armoire 2 pompes Tri 4.8kW 10.1A double portes sur socle, Sofrel S4W, Magelis, sonde pi√©zo + poires en secours, variateur de fr√©quence.  \n> Livraison souhait√©e le 19/02/2025.\n\n**Sortie attendue :**\n{\n  \"Client\": \"HYDRA\",\n  \"Interlocuteur\": \"Olivier Dussart\",\n  \"Armoires\": [\n    {\n      \"Titre\": \"Armoire 2 pompes Tri 4.8kW 10.1A Double portes sur socle\",\n      \"Options\": [\"Sofrel S4W\", \"√âcran Magelis\", \"Variateur de fr√©quence\"],\n      \"R√©gulation\": [\"Sonde pi√©zo\", \"Poires de niveau\"]\n    }\n  ],\n  \"D√©lai demand√©\": \"19/02/2025\",\n  \"Pi√®ces jointes\": [\"CCTP\", \"DQE\"],\n  \"Notes\": [\n    \"Le coffret doit √™tre install√© sur un socle b√©ton existant\",\n    \"Zone ATEX ‚Äì composants √† adapter\",\n    \"Demande de devis urgente\"\n  ]\n}\n\n---\n\nVoici le mail et ses pi√®ces jointes √† analyser :\n${fullText}\n`\n        }\n      ],\n      temperature: 0.1 // plus rigoureux, moins inventif\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        336
      ],
      "id": "d396020a-235a-4d19-88b6-ddfd2c615d46",
      "name": "Cr√©ation du prompt"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        304,
        320
      ],
      "id": "d3a8846c-b5c2-42df-b964-1595cca852c6",
      "name": "Merge1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "36015dba-dd76-4e2d-9b37-eb05cc7845ac",
              "leftValue": "={{ $json.status }}",
              "rightValue": "valide",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1120,
        336
      ],
      "id": "cf92a61d-9891-4cb1-9d01-b865e38d4eb2",
      "name": "r√©sum√© valide ?"
    },
    {
      "parameters": {
        "jsCode": "// R√©cup√®re la cha√Æne JSON\nlet jsonStr = $input.first().json.data;\n\n// Retire les backticks et le marqueur ```json\njsonStr = jsonStr.replace(/```json\\s*|```/g, '').trim();\n\n// Parse le JSON\nlet data;\ntry {\n  data = JSON.parse(jsonStr);\n} catch (e) {\n  return [{ json: { html: `<p>Erreur parsing JSON : ${e.message}</p>` } }];\n}\n\n// G√©n√©ration HTML\nlet html = `\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    <style>\n      body { font-family: Arial, sans-serif; margin: 40px; color: #222; background-color: white; }\n      h1 { color: #004080; }\n      .bloc { margin-bottom: 20px; }\n      .label { font-weight: bold; }\n      .armoire { margin-left: 20px; }\n      ul { margin-top: 5px; margin-bottom: 5px; }\n    </style>\n  </head>\n  <body>\n    <h1>Demande de devis</h1>\n`;\n\n// Client\nhtml += `<div class=\"bloc\"><span class=\"label\">Client :</span> ${data.Client || ''}</div>`;\n\n// Interlocuteur\nhtml += `<div class=\"bloc\"><span class=\"label\">Interlocuteur :</span> ${data.Interlocuteur || ''}</div>`;\n\n// Armoires\nif (data.Armoires && data.Armoires.length) {\n  html += `<div class=\"bloc\"><span class=\"label\">Armoires :</span>`;\n  data.Armoires.forEach((armoire, idx) => {\n    html += `<div class=\"armoire\"><strong>Armoire ${idx + 1} :</strong> ${armoire.Titre || ''}`;\n    \n    if (armoire.Options && armoire.Options.length) {\n      html += `<div class=\"armoire\"><span class=\"label\">Options :</span><ul>`;\n      armoire.Options.forEach(opt => html += `<li>${opt}</li>`);\n      html += `</ul></div>`;\n    }\n    \n    if (armoire.R√©gulation && armoire.R√©gulation.length) {\n      html += `<div class=\"armoire\"><span class=\"label\">R√©gulation :</span><ul>`;\n      armoire.R√©gulation.forEach(reg => html += `<li>${reg}</li>`);\n      html += `</ul></div>`;\n    }\n\n    html += `</div>`; // fin armoire\n  });\n  html += `</div>`; // fin bloc armoires\n}\n\n// D√©lai demand√©\nhtml += `<div class=\"bloc\"><span class=\"label\">D√©lai demand√© :</span> ${data[\"D√©lai demand√©\"] || ''}</div>`;\n\n// Notes\nif (data[\"Notes\"] && data[\"Notes\"].length) {\n  html += `<div class=\"bloc\"><span class=\"label\">Notes :</span><ul>`;\n  data[\"Notes\"].forEach(note => html += `<li>${note}</li>`);\n  html += `</ul></div>`;\n}\n\n// Pi√®ces jointes\nif (data[\"Pi√®ces jointes\"] && data[\"Pi√®ces jointes\"].length) {\n  html += `<div class=\"bloc\"><span class=\"label\">Pi√®ces jointes :</span><ul>`;\n  data[\"Pi√®ces jointes\"].forEach(pj => html += `<li>${pj}</li>`);\n  html += `</ul></div>`;\n}\n\nhtml += `\n  </body>\n</html>\n`;\n\nreturn [{ json: { html }}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        272
      ],
      "id": "1bb12c8d-a512-4f15-b852-ea4a57f4c040",
      "name": "conversion en html"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.output;\n\n// Fonction utilitaire pour v√©rifier si tout est \"Non pr√©cis√©\"\nfunction isEmptyValue(val) {\n  if (typeof val === 'string') {\n    return val.trim().toLowerCase().includes('non pr√©cis√©') || val.trim() === '';\n  }\n  if (Array.isArray(val)) {\n    return val.length === 0 || val.every(isEmptyValue);\n  }\n  if (typeof val === 'object' && val !== null) {\n    return Object.values(val).every(isEmptyValue);\n  }\n  return false;\n}\n\n// V√©rifie les champs importants\nconst emptyClient = isEmptyValue(data.Client);\nconst emptyInterlocuteur = isEmptyValue(data.Interlocuteur);\nconst emptyArmoires = !data.Armoires || data.Armoires.length === 0 || data.Armoires.every(isEmptyValue);\nconst emptyDelai = isEmptyValue(data[\"D√©lai demand√©\"]);\n\nconst isMostlyEmpty = emptyClient && emptyInterlocuteur && emptyArmoires && emptyDelai;\n\nif (isMostlyEmpty) {\n  return [{ json: { status: \"invalide\", reason: \"Toutes les donn√©es sont non pr√©cis√©es\", data } }];\n}\n\nreturn [{ json: { status: \"valide\", data } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        336
      ],
      "id": "44394639-fef1-40c5-b568-ac9e7569ff89",
      "name": "cr√©ation statut"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1296,
        400
      ],
      "id": "17f11f40-fd63-441c-9a43-9b0a02ea9551",
      "name": "Mail autre 2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "\"mail_agent\""
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        32,
        640
      ],
      "id": "433644af-986b-4bb9-90f5-6079dfc7a6ce",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "model": "codestral-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -112,
        640
      ],
      "id": "00026e80-99c9-4a11-9147-57a72a767fc7",
      "name": "Mistral Cloud Chat Model2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "\"mail_agent\""
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        160,
        0
      ],
      "id": "87b292ab-155b-4761-9590-93b717166741",
      "name": "Simple Memory3"
    },
    {
      "parameters": {
        "model": "codestral-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "90dc4e94-f440-437a-8f69-17cf139ca258",
      "name": "Mistral Cloud Chat Model3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voici un texte qui provient d'un fichier excel, j'aimerais que tu me renvoie un extrait ou r√©sum√© de la partie qui porte sur l'armoire √©l√©ctrique (ou coffret), si le document ne porte pas sur une armoire √©l√©ctrique alors tu peux dire que le document ne porte pas sur l'armoire\nVoici le document :\n{{ $json.mergedText }}\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        0,
        144
      ],
      "id": "25290a51-a2e4-4329-acfb-70ddb71b92ea",
      "name": "AI r√©sume Excel"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.messages[0].content }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        640,
        336
      ],
      "id": "6cfbc539-42ab-48b9-81b1-b08668a42ec4",
      "name": "AI r√©sum√© final"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -288,
        144
      ],
      "id": "82d6ff3e-470d-400b-8476-3b990049cdd5",
      "name": "Merge2"
    },
    {
      "parameters": {
        "operation": "xls",
        "binaryPropertyName": "dataExcel",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -448,
        64
      ],
      "id": "74ea1d4d-2816-46ac-a9dd-9f595d3ea7b9",
      "name": "Extract from XLS"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "dataExcel",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -448,
        224
      ],
      "id": "cefd7811-deca-49d3-b93a-2cff3b0e6421",
      "name": "Extract from XLSX"
    },
    {
      "parameters": {
        "jsCode": "const itemsOut = [];\n\nfor (const item of items) {\n  // Parcours toutes les pi√®ces jointes binaires\n  for (const key of Object.keys(item.binary || {})) {\n    const file = item.binary[key];\n\n    if (\n      file.mimeType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' // .xlsx\n    ) {\n      itemsOut.push({\n        json: {\n          originalMailId: item.json.id,\n          fileName: file.fileName,\n        },\n        binary: {\n          dataExcel: file, // le nom \"dataExcel\" sera utilis√© dans Read from Spreadsheet\n        },\n      });\n    }\n  }\n}\n\nreturn itemsOut;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        224
      ],
      "id": "0df81f0a-14d0-4069-93b8-19b777223023",
      "name": "Code avoir XLSX"
    },
    {
      "parameters": {
        "jsCode": "const itemsOut = [];\n\nfor (const item of items) {\n  // Parcours toutes les pi√®ces jointes binaires\n  for (const key of Object.keys(item.binary || {})) {\n    const file = item.binary[key];\n\n    if (\n      file.mimeType === 'application/vnd.ms-excel' // .xls\n    ) {\n      itemsOut.push({\n        json: {\n          originalMailId: item.json.id,\n          fileName: file.fileName,\n        },\n        binary: {\n          dataExcel: file, // le nom \"dataExcel\" sera utilis√© dans Read from Spreadsheet\n        },\n      });\n    }\n  }\n}\n\nreturn itemsOut;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        64
      ],
      "id": "131caa61-1243-4351-b99d-d1e66e3046d4",
      "name": "Code avoir XLS"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voici un pdf, j'aimerais que tu me renvoie :\n- Titre\n- Extrait de la partie qui porte sur l'armoire √©l√©ctrique (ou coffret)\nSi le document ne porte pas sur une armoire √©l√©ctrique alors ne me renvoie absolument rien.\nvoici le document :\n{{ $('Code avoir PDF').item.json.fileName }}\n{{ $json.text }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -112,
        480
      ],
      "id": "da10e425-78b4-407c-a18f-b87c3e51b0a6",
      "name": "AI r√©sume texte"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1248,
        496
      ],
      "id": "3b706779-d8bf-4233-bf80-a38055a1c84b",
      "name": "Reprise des PJ du mail d'entr√©e"
    },
    {
      "parameters": {
        "jsCode": "let text = \"\";\n\nfor (const item of items) {\n  for (const [key, value] of Object.entries(item.json)) {\n    // Exclut les colonnes inutiles comme \"poids\" si tu veux\n    if (key !== \"poids (/5)\") {\n      text += `${key} : ${value}\\n`;\n    }\n  }\n  text += \"\\n\"; // s√©parateur entre les lignes\n}\n\nreturn [\n  {\n    json: {\n      mergedText: text\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        144
      ],
      "id": "2f9b5c3c-4957-4224-8a13-7baa7a601b79",
      "name": "Regroupement items"
    },
    {
      "parameters": {
        "jsCode": "const htmlContent = $('Microsoft Outlook Trigger').first().json.body.content;\n\n// Retire toutes les balises HTML\nlet text = htmlContent.replace(/<[^>]*>/g, ' ');\n\n// Remplace les entit√©s HTML courantes (&nbsp;, &amp;, etc.)\ntext = text.replace(/&nbsp;/g, ' ')\n           .replace(/&amp;/g, '&')\n           .replace(/&lt;/g, '<')\n           .replace(/&gt;/g, '>')\n           .replace(/&quot;/g, '\"')\n           .replace(/&#39;/g, \"'\");\n\n// Nettoie les espaces multiples et retours √† la ligne\ntext = text.replace(/\\s+/g, ' ').trim();\n\nreturn [{ json: { text } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        336
      ],
      "id": "143a4ec8-6885-4e3e-b77f-7f6fad756102",
      "name": "Nettoyage texte mail"
    },
    {
      "parameters": {
        "html": "{{ $json.html }}"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        1472,
        272
      ],
      "id": "55f6ea07-bdbd-4665-a0e1-b234041cb704",
      "name": "HTML"
    }
  ],
  "pinData": {
    "HTML": [
      {
        "json": {
          "html": "\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    <style>\n      body { font-family: Arial, sans-serif; margin: 40px; color: #222; background-color: white; }\n      h1 { color: #004080; }\n      .bloc { margin-bottom: 20px; }\n      .label { font-weight: bold; }\n      .armoire { margin-left: 20px; }\n      ul { margin-top: 5px; margin-bottom: 5px; }\n    </style>\n  </head>\n  <body>\n    <h1>Demande de devis</h1>\n<div class=\"bloc\"><span class=\"label\">Client :</span> HYDRA</div><div class=\"bloc\"><span class=\"label\">Interlocuteur :</span> Olivier Dussart</div><div class=\"bloc\"><span class=\"label\">Armoires :</span><div class=\"armoire\"><strong>Armoire 1 :</strong> Armoire 2 pompes Tri 4.8kW 10.1A Double portes sur socle<div class=\"armoire\"><span class=\"label\">Options :</span><ul><li>Sofrel S4W</li><li>√âcran Magelis 7 pouces</li><li>Variateurs de fr√©quence</li><li>D√©bitm√®tre Promag W400</li><li>Pompe vide cave</li><li>Pompe eaux industrielles</li><li>Sonde pi√©zo suivi nappe</li><li>D√©tecteur de surverse</li><li>T√©l√©gestion GSM</li><li>Potence int√©gr√©e avec palan</li><li>Automate √©cran 5,7 pouces</li><li>Transformateur 400VAC/24VAC</li><li>Alimentation 230VAC/24VDC</li><li>R√©sistance chauffante avec thermostat</li><li>Interrupteur g√©n√©ral diff√©rentiel 300mA</li><li>Relais de contr√¥le de phase</li><li>Protection des appareils par disjoncteur</li><li>Batterie 12VDC / 12AH</li><li>Disjoncteurs et Parafoudres</li></ul></div><div class=\"armoire\"><span class=\"label\">R√©gulation :</span><ul><li>Sonde pi√©zo</li><li>Poires de niveau</li><li>Variateur de fr√©quence</li><li>D√©bitm√®tre Promag W400</li></ul></div></div></div><div class=\"bloc\"><span class=\"label\">D√©lai demand√© :</span> 19/02/2025</div><div class=\"bloc\"><span class=\"label\">Notes :</span><ul><li>Le coffret doit √™tre install√© sur un socle b√©ton existant</li><li>Demande de devis urgente</li><li>Zone ATEX ‚Äì composants √† adapter</li></ul></div><div class=\"bloc\"><span class=\"label\">Pi√®ces jointes :</span><ul><li>MP_2023-14_24_Programme_de_travaux-PRO_R3-SR2.pdf</li><li>Communaut√© d'Agglom√©ration Epernay Coteaux et Plaine de Champagne : Bassin de r√©tention de 520 m3 et reprise du transfert des eaux us√©es de Oiry-Plivot vers SR2.xlsx</li></ul></div>\n  </body>\n</html>\n"
        }
      }
    ]
  },
  "connections": {
    "Microsoft Outlook Trigger": {
      "main": [
        [
          {
            "node": "Code enlever PJ",
            "type": "main",
            "index": 0
          },
          {
            "node": "Reprise des PJ du mail d'entr√©e",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "AI r√©sume texte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI r√©sum√© final",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI r√©sum√© final",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI D√©t√©ction demande",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI D√©t√©ction demande",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI D√©t√©ction demande": {
      "main": [
        [
          {
            "node": "demande de devis ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code avoir PDF",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code avoir XLSX",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code avoir XLS",
            "type": "main",
            "index": 0
          },
          {
            "node": "Nettoyage texte mail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code enlever PJ": {
      "main": [
        [
          {
            "node": "AI D√©t√©ction demande",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "demande de devis ?": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code avoir PDF": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Cr√©ation du prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cr√©ation du prompt": {
      "main": [
        [
          {
            "node": "AI r√©sum√© final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "r√©sum√© valide ?": {
      "main": [
        [
          {
            "node": "conversion en html",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mail autre 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "conversion en html": {
      "main": [
        [
          {
            "node": "HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cr√©ation statut": {
      "main": [
        [
          {
            "node": "r√©sum√© valide ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI r√©sume texte",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI r√©sume texte",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory3": {
      "ai_memory": [
        [
          {
            "node": "AI r√©sume Excel",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "AI r√©sume Excel",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI r√©sume Excel": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI r√©sum√© final": {
      "main": [
        [
          {
            "node": "cr√©ation statut",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from XLS": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from XLSX": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Regroupement items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code avoir XLSX": {
      "main": [
        [
          {
            "node": "Extract from XLSX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code avoir XLS": {
      "main": [
        [
          {
            "node": "Extract from XLS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI r√©sume texte": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Reprise des PJ du mail d'entr√©e": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Regroupement items": {
      "main": [
        [
          {
            "node": "AI r√©sume Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Nettoyage texte mail": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "9d67137d-d650-4144-8374-c6a69f30a0f1",
  "meta": {
    "instanceId": "790517cc9de6016999eef616e344f28d0cfe24a34aad918ccaed82d30119b079"
  },
  "id": "6Pnnb9BDAwPQ4NbB",
  "tags": []
}